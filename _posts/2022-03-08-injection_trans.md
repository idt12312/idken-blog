---
layout: post
title: 注入トランスをつくる
category: 電子工作
tag:
    - 電子工作
comments: true
thumb: /images/injection_trans1.jpg
---
電源などのフィードバック系のループゲインをオシロで測るための注入トランスを作りました。



# はじめに
電源などのフィードバック系のループゲイン(一巡伝達)をオシロで測るための注入トランスを作りました。
平たく言うと広帯域な1:1のトランスです。

この注入トランスを使ってループゲインを測定する例として以下のようなものがあります。
こういうことをやりたいので作りました。

* [AnalogDialogue "ADALM2000：ループ・ゲインの測定"](https://www.analog.com/jp/analog-dialogue/studentzone/studentzone-july-2019.html)
* [Trktronix "制御ループ解析"](https://www.tek.com/ja/solutions/application/control-loop-analysis)
* [RIGOL "MSO5000シリーズ ボード線図機能"](https://jp.rigol.com/NEWS/news/50.html)


![](/images/injection_trans1.jpg){:data-action="zoom"}

中にはトロイダルトランスが入っています。

![](/images/injection_trans2.jpg){:data-action="zoom"}

## 元ネタ・他の制作例

こういう注入トランスは製品として販売されているものがあります。
例えばpico test という会社の[J2101A](https://www.picotest.com/products_J2101A.html)はオシロメーカーのアプリケーションノートとかにもよく出てきます。

この注入トランスが結構高いからか、自作している事例がいくらか見つかりました。

* [eevblog "DIY Injection Transformer for Power Supply Control Loop Response Measurements"](https://www.eevblog.com/forum/projects/diy-injection-transformer-for-power-supply-control-loop-response-measurements/)  
* [Electronic Projects for Fun "Injection Transformers"](https://electronicprojectsforfun.wordpress.com/injection-transformers/)

特に以下の記事にある、LANケーブルを使うアイディアとコアの例は参考にさせていただきました。

* [DIY projects of an EE student "Homemade Injection Transformer for PSU Loop Analysis"](https://adilmalikn.wordpress.com/2019/07/07/homemade-inject-transformer-for-psu-loop-analysis/)


# 作り方

トランスは以下のような材料で作りました。

<table>
<tr>
    <td>コア</td>
    <td>TDK, B64290L0674X038</td>
</tr>
<tr>
    <td>巻き線</td>
    <td>Cat5eのLANケーブルのツイストペア線 30回巻き</td>
</tr>
<tr>
    <td>ケース</td>
    <td>タカチ, EXP9-5-13SI</td>
</tr>
</table>

ツイストペア線は家にあったLANケーブルをばらして使っています。

低域までゲインを伸ばすために励磁インダクタンスを大きくしないといけなので、透磁率が高いコアを使っています。
スイッチング電源のようにDCで大電流は流さず、小信号しか流さないので磁束の飽和はそこまで気になりません(入力信号を大きくすると影響が見えてきましたが)。

高域までゲインを伸ばすためには漏れインダクタンスと線間容量を減らす必要があります。
トロイダルコアを使い、ツイストペア線をバイファイラ巻きすることで漏れインダクタンスが小さくできます(≒結合係数が高い)。
大きなサイズのトロイダルコアに間隔をあけて線をまくことで線間容量を減らしています。

いろんなコアと線の巻き方を試した結果、上の表のように作ると便利に使えそうな特性になりました。

![](/images/injection_trans3.jpg){:data-action="zoom"}


ツイストペア線は白い線と青い線が捩られていて、白い線、青い線がそれぞれ1,2次の巻き線になっています。
トランスの巻き線部分は1,2次をよく結合させたいので、ツイストペア線をもとの青白のペアのまま巻いています。
トランスの入出力部分は1,2次で分けないといけないので、ツイストペア線をばらして青青の組と白白の組に捩りなおしています。


ケースはタカチのEXPシリーズのものを使っています。
滑り止めがあるのと、ワンポイントで色がついているのが好きです。
BNCやバナナ端子はケースのアルミに穴をあけて固定しています。
トランスの台座は3Dプリンタで作り、トランスをケースに固定しています。

# トランスの特性

## 周波数特性

RIGOLの黒いオシロ(MSO5000)のFRA機能使って、50ohm終端した場合の周波数応答を測りました。
測定回路は以下の通りです。

![](/images/injection_trans_char_measure.svg){:data-action="zoom"}

50Ohm負荷時のトランスの1次2次間の周波数特性は以下のようになりました。

![](/images/injection_trans_char.svg){:data-action="zoom"}

かなり低域まで伸びている測定結果になっていますが、100Hz以下の測定結果は怪しいです。
信号レベルが小さくなってしまったことと、低周波であることが原因なのか、オシロのFRA機能で測定中の挙動が怪しかったです。
後述するトランスの励磁インダクタンスの値からも、こんなに低域までゲインは伸びていないはずです。

低域に怪しい点がありますが、少なくとも数100Hzから数MHzくらいまで注入トランスとして使えそうです。
実際にループゲインを測定するときにはトランスの2次側でループの入出力の比を測定するので、理想的にはトランスの周波数特性は測定結果には影響しません。
実際にはトランスのゲインが小さい周波数では入力される信号が小さくなってしまうので、測りたい信号がノイズやオシロの分解能に埋もれてしまいます。
あまり厳密さは必要ありませんが、トランスのゲインがある程度ある領域でしか使えないことになります。

## トランスのモデル化

トランスの簡単なモデルに実測値を当てはめると以下のようになりました。

![](/images/injection_trans_model.svg){:data-action="zoom"}

励磁インダクタンスは2次側をオープンにして、1次側のインダクタンスを測ることで測定しています。
この測定では励磁インダクタンスと1次側漏れインダクタンスの合計値が測定されてしまいますが、
今回は漏れインダクタンスが無視できるくらい小さいので問題ありません。

コアのAL valueは13500 ±30% nHで、30回巻いているのでインダクタンスは12 ±30% mHくらいになるはずです。
実測値は16mHとコアの誤差+αの誤差がありますが、適当に巻いているのでこのくらいはずれるのかもしれないです。

寄生インダクタンスは2次側をショートして、1次側のインダクタンスを測ることで測定しています。
1次側も2次側も同じ作りをしているので漏れインダクタンスも同じだと仮定して同じ値にしています。

インダクタンスの測定はオシロとファンクションジェネレータを使って位相がちょうど45°遅れるところを探して測定しました。
寄生容量も測りたかったのですが、この方法ではうまく測れませんでした。なのでモデルにも入れていません。

# 実際に使う

なるべくディスクリートな部品でバックコンバータを作ったので、試しにこのバックコンバータのループゲインを測定してみました。
負荷として[以前作った電子負荷](/posts/2021-11-13-eload/)を使っています。

![](/images/injection_trans_dcdc.jpg){:data-action="zoom"}

このバックコンバータのループゲインの特性は以下のようになっていました。

![](/images/injection_trans_dcdc_measure.svg){:data-action="zoom"}

グラフはspiceでシミュレーションしたものと重ねています。
シミュレーションではバックコンバータ部分を平衡点周りで線形化したモデルを使っています。
PWM1周期分の無駄時間も入れています(数十kHz以上の領域での位相遅れにかなり効いていた)。

補償器はゲイン交差周波数が30kHzになるように設計していて、Type III補償器で実装しています。
ゲイン交差周波数は実機とシミュレーションでほぼ同じになっているようです。

5kHzくらいにある共振っぽいものは出力のLCによるものです。
この共振自体は再現できていますが、共振点付近でゲインがずれているのは謎です。
ゲイン交差周波数あたりがうまくできていたのでいいか、と深追いはしませんでした。

実機の測定では、スイッチング周波数に近い数100kHz以上の領域や、ループゲインの高くなる低周波の領域ではうまく測定できませんでした。
スイッチング周波数に近くなるともはや線形モデルで考えるのが妥当ではないので、測れないのはしょうがないというか必要ないです。
低周波側でうまく測れないのはオシロの性能によるものかなと思います。
使ってみた感触として、うまく測れるのはゲインが+-40dBくらいの範囲です。


# おわりに

この方法で正確に測れるループゲインの範囲は、普段spiceのシミュレーションで見ているものに比べて狭いなという印象を受けました。
周波数は100Hz~1MHzくらい、ループゲインが+-40dBくらいである範囲だけある必要があります。

ループゲインの特性に限定すれば精度よく測定したいのはゲイン交差周波数周りなので、+-40dB範囲しか見れないというのはきつい制約のようで要求には反さない制約なのだと思います。
電源やあまり速くないアンプ回路であれば、ゲイン交差周波数が100Hz~1MHzくらいになっているので使えそうです。

ここまで書いたところで、最近Twitterで@yoshikiyo611さんがよりコンパクトな注入トランスを作っているのを見かけて衝撃を受けました。小さくても十分に低域までゲインは伸びていて、何よりも小さく作れることがいいですね。今回の記事ではトロイダルコアで作る方法を紹介しましたが、ほかにもやりようはあるようです。

<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">信号注入用の絶縁トランスできた。100Hz～100kHzまでなら使えるかな <a href="https://t.co/XvEBNfSK8G">pic.twitter.com/XvEBNfSK8G</a></p>&mdash; yoshikiyo (@yoshikiyo611) <a href="https://twitter.com/yoshikiyo611/status/1502336072386510848?ref_src=twsrc%5Etfw">March 11, 2022</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
